name: C++ CI

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  bump_version:
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.bump.outputs.new_tag }}
      major: ${{ steps.bump.outputs.major }}
      minor: ${{ steps.bump.outputs.minor }}
      patch: ${{ steps.bump.outputs.patch }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump version
        id: bump
        shell: bash
        run: |
          git fetch --tags --quiet
          last_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "1.0.0")
          last_tag=${last_tag#v}
          IFS='.' read -r major minor patch <<< "$last_tag"

          while true; do
            patch=$((patch+1))
            new_tag="$major.$minor.$patch"

            if git rev-parse -q --verify "refs/tags/$new_tag" >/dev/null 2>&1; then
              continue
            fi
            if git ls-remote --tags origin "refs/tags/$new_tag" | grep -q "$new_tag"; then
              continue
            fi

            git tag "$new_tag"
            git push origin "refs/tags/$new_tag"
            echo "new_tag=$new_tag" >> "$GITHUB_OUTPUT"
            echo "major=$major" >> "$GITHUB_OUTPUT"
            echo "minor=$minor" >> "$GITHUB_OUTPUT"
            echo "patch=$patch" >> "$GITHUB_OUTPUT"
            break
          done

  build_and_package:
    needs: bump_version
    runs-on: ${{ matrix.os }}
    timeout-minutes: 25
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - uses: actions/checkout@v3

      - name: Clean build directory
        shell: bash
        run: |
          rm -rf build
          mkdir build

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config ninja-build libboost-program-options-dev libboost-filesystem-dev

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Устанавливаем инструменты
          choco install cmake ninja -y
          
          # Скачиваем Boost с официального сайта (используем другой URL)
          Write-Host "Downloading Boost from official site..."
          $url = "https://boostorg.jfrog.io/artifactory/main/release/1.83.0/source/boost_1_83_0.7z"
          
          # Пробуем несколько источников
          try {
              Invoke-WebRequest -Uri $url -OutFile "boost_1_83_0.7z"
              Write-Host "Successfully downloaded from primary source"
          } catch {
              Write-Host "Trying alternative source..."
              $url = "https://archives.boost.io/release/1.83.0/source/boost_1_83_0.7z"
              Invoke-WebRequest -Uri $url -OutFile "boost_1_83_0.7z"
          }
          
          # Создаем директорию
          New-Item -ItemType Directory -Force -Path "C:\boost"
          
          # Распаковываем с помощью встроенного PowerShell
          Write-Host "Extracting Boost..."
          
          # Если есть 7zip, используем его
          if (Test-Path "C:\ProgramData\chocolatey\bin\7z.exe") {
              & "C:\ProgramData\chocolatey\bin\7z.exe" x boost_1_83_0.7z -oC:\boost
          } else {
              # Иначе используем Expand-Archive (если это .zip)
              Expand-Archive -Path "boost_1_83_0.7z" -DestinationPath "C:\boost" -Force
          }
          
          # Проверяем, что файлы распаковались
          if (Test-Path "C:\boost\boost_1_83_0\boost") {
              Write-Host "Boost extracted successfully"
          
              # Устанавливаем переменные окружения
              echo "BOOST_ROOT=C:\boost\boost_1_83_0" >> $env:GITHUB_ENV
              echo "BOOST_INCLUDEDIR=C:\boost\boost_1_83_0" >> $env:GITHUB_ENV
          
              # Для Windows нужно собрать библиотеки
              Write-Host "Building Boost libraries..."
              cd C:\boost\boost_1_83_0
          
              # Запускаем bootstrap
              .\bootstrap.bat
          
              # Собираем только нужные библиотеки
              .\b2 --with-program_options --with-filesystem --with-crc toolset=msvc address-model=64 variant=release link=static runtime-link=shared stage
          
              echo "BOOST_LIBRARYDIR=C:\boost\boost_1_83_0\stage\lib" >> $env:GITHUB_ENV
          } else {
              Write-Host "Boost extraction failed, using vcpkg fallback"
          
              # Fallback: используем vcpkg
              git clone https://github.com/microsoft/vcpkg.git
              cd vcpkg
              .\bootstrap-vcpkg.bat
              .\vcpkg install boost-program-options:x64-windows boost-filesystem:x64-windows boost-crc:x64-windows
          
              echo "VCPKG_ROOT=${{ github.workspace }}\vcpkg" >> $env:GITHUB_ENV
              echo "CMAKE_TOOLCHAIN_FILE=${{ github.workspace }}\vcpkg\scripts\buildsystems\vcpkg.cmake" >> $env:GITHUB_ENV
          }

      - name: Configure and Build
        shell: bash
        env:
          PROJECT_VERSION_MAJOR: ${{ needs.bump_version.outputs.major }}
          PROJECT_VERSION_MINOR: ${{ needs.bump_version.outputs.minor }}
          PROJECT_VERSION_PATCH: ${{ needs.bump_version.outputs.patch }}
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            # Для Windows - указываем путь к Boost
            cmake -G "Ninja" -S . -B build \
              -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/build/package \
              -DBOOST_ROOT="${{ env.BOOST_ROOT }}" \
              -DBOOST_LIBRARYDIR="${{ env.BOOST_LIBRARYDIR }}" \
              -DCPACK_PACKAGE_CONTACT="github-actions@example.com" \
              -DCPACK_DEBIAN_PACKAGE_MAINTAINER="GitHub Actions <github-actions@example.com>"
          else
            # Для Linux
            cmake -G "Ninja" -S . -B build \
              -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/build/package \
              -DCPACK_PACKAGE_CONTACT="github-actions@example.com" \
              -DCPACK_DEBIAN_PACKAGE_MAINTAINER="GitHub Actions <github-actions@example.com>"
          fi
          
          cmake --build build --parallel 2

      - name: Create package directory
        shell: bash
        run: |
          mkdir -p ${{ github.workspace }}/build/package

      - name: Install to package directory
        shell: bash
        run: |
          cmake --install build --prefix ${{ github.workspace }}/build/package

      - name: Package
        shell: bash
        run: |
          cd build
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            cpack -G ZIP
          else
            cpack -G DEB
          fi

      - name: Upload
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.bump_version.outputs.new_tag }}
          files: build/*.deb build/*.zip